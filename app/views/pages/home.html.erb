<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Mapbox GL JS CSS -->
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
  
  <title>Map with Sidebar</title>
  
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #272727;
    }

    .container-fluid {
      height: 100%;
      padding: 1rem;
    }

    .row.h-100 {
      height: 100%;
    }

    .col-md-4, .col-md-8 {
      height: 100%;
    }

    #sidebar, #map {
      height: 100%;
      border-radius: 0.7rem;
    }

    #sidebar {
      background: #323232;
      color: #fff;
      padding: 1.5rem;
      overflow-y: scroll; /* Allow scrolling */
      scrollbar-width: none; /* For Firefox */
    }

    /* Hide scrollbar for Chrome, Safari, and Opera */
    #sidebar::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbar for Internet Explorer and Edge */
    #sidebar {
      -ms-overflow-style: none; /* IE and Edge */
    }
  </style>
</head>
<body>
  
  <div class="container-fluid h-100 p-5">
    <div class="row h-100">
      
      <!-- Sidebar Column -->
      <div class="col-md-4 h-100">
        <div id="sidebar" class="h-100 w-100">
          <h4 class="mb-4">Satelites above you ðŸš€</h4>
          <div id="satellite-cards">
            <!-- Satellite cards will go here -->
          </div>
        </div>
      </div>
      
      <!-- Map Column -->
      <div class="col-md-8 h-100">
        <div id="map" class="h-100 w-100"></div>
      </div>
    </div>
  </div>
  
  <!-- Mapbox GL JS -->
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
  
  <script>
    // Replace with your Mapbox API access token
    mapboxgl.accessToken = "<%= @mapbox_token %>";

    // Initialize the map with disabled interactions
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [16.931992, 52.409538],
      zoom: 5,
      interactive: false
    });

    // Satellite data from Ruby controller
    const satellites = <%= raw @satelites_list.to_json %>;

    // Observer's location (replace with actual observer's coordinates if available)
    const observerLat = 52.409538;
    const observerLng = 16.931992;

    // Function to calculate distance between two coordinates using the Haversine formula
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in kilometers
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    if (satellites && satellites.length > 0) {
      // Calculate distance for each satellite and add it as a new property
      satellites.forEach((satellite) => {
        satellite.distance = calculateDistance(
          observerLat, 
          observerLng, 
          satellite.observer_lat, 
          satellite.observer_lng
        );
      });

      // Sort satellites from closest to furthest
      satellites.sort((a, b) => a.distance - b.distance);

      // Get the satellite cards container
      const satelliteCardsContainer = document.getElementById('satellite-cards');

      satellites.forEach((satellite) => {
        // Create a marker on the map
        new mapboxgl.Marker({ color: "red" })
          .setLngLat([satellite.observer_lng, satellite.observer_lat])
          .setPopup(new mapboxgl.Popup().setText(satellite.satname))
          .addTo(map);

        // Create a card for the sidebar
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.style.backgroundColor = '#424242'; // Match sidebar theme
        card.style.color = '#fff'; // Ensure text is visible

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';

        const title = document.createElement('h5');
        title.className = 'card-title';
        title.textContent = satellite.satname;

        const lat = document.createElement('p');
        lat.className = 'card-text';
        lat.textContent = `Latitude: ${satellite.observer_lat.toFixed(4)}`;

        const lng = document.createElement('p');
        lng.className = 'card-text';
        lng.textContent = `Longitude: ${satellite.observer_lng.toFixed(4)}`;

        const distance = document.createElement('p');
        distance.className = 'card-text';
        distance.textContent = `Distance: ${satellite.distance.toFixed(2)} km`;

        cardBody.appendChild(title);
        cardBody.appendChild(lat);
        cardBody.appendChild(lng);
        cardBody.appendChild(distance);
        card.appendChild(cardBody);

        satelliteCardsContainer.appendChild(card);
      });
    } else {
      console.log("No satellite data available to display.");
    }
  </script>
  
  <!-- Optional Bootstrap JS and dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
</body>
</html>
